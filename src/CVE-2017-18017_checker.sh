#! /bin/bash
####
## network-magic is tools for network administrators.
##
## Copyright (C) 2018 Shintaro Fujiwara 
##
## This program is free software; you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with this program; if not, write to the Free Software
## Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
####

####
## this script tries to sets xt_TCPMSS setting and its module (CVE-2017-18017) related 
##
## author: Shintaro Fujiwara: shintaro.fujiwara [at gmail dot com]
####
 
#### configs ####
DATE=$(date '+%Y%m%d%H%M%S')
CONFIG_FILE="/etc/sysconfig/iptables"
MODULE_NAME="xt_TCPMSS"
#### end configs ####

#### functions ####

## this function clears iptables rules
function cleanup_iptables()
{
    iptables -Z
    if [ $? -eq 0 ]; then
        echo ""
        echo "-------- Deleted iptables RULES --------"
    else
        echo ""
        echo "-------- Oops! Failed to delete iptables RULES... --------"
        exit 1
    fi
    sleep 5

    service iptables stop 
    if [ $? -eq 0 ]; then
        echo ""
        echo "-------- Stopped iptables OK --------"
    else
        echo ""
        echo "-------- Oops! Failed to stop iptables... --------"
        exit 1
    fi

    rmmod ${MODULE_NAME} >/dev/null
    if [ $? -eq 0 ]; then
        echo ""
        echo "-------- removed module ${MODULE_NAME} --------"
        rm ${CONFIG_FILE} >/dev/null 2>&1
    else
        echo ""
        echo "-------- module ${MODULE_NAME} does not seem to be present... --------"
    fi
}

# this funcion checks if there is mangle table present
function check_mangle_table()
{
    grep mangle ${CONFIG_FILE} >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo ""
        echo "-------- mangle table seems to be present --------"
    else
        echo ""
        echo "-------- mangle table does not seem to be present --------"
    fi
}

# this function checks xt_TCPMSS module is loaded or not
function check_xt_tcpmss()
{
    grep ${MODULE_NAME} /proc/modules >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo ""
        grep ${MODULE_NAME} /proc/modules
        echo "-------- ${MODULE_NAME} is loaded --------"
    else
        echo ""
        echo "-------- ${MODULE_NAME} module is not loaded --------"
    fi
}

# this function sets xt_TCPMSS setting and its module
function set_tcpmss()
{
    set -x
    iptables -A PREROUTING -t mangle -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1380
    set +x
}

#### end functions ####
#### main part ####
cleanup_iptables
sleep 5
check_mangle_table
sleep 5
service iptables start
sleep 5
check_xt_tcpmss
sleep 5
set_tcpmss
sleep 5
service iptables save
sleep 5
check_mangle_table
sleep 5
check_xt_tcpmss
sleep 15
iptables -L
echo ""
echo "-------- cat ${CONFIG_FILE} --------"
cat ${CONFIG_FILE}
sleep 5
echo ""
echo "-------- service iptables status --------"
service iptables status 
echo ""
sleep 5
echo "-------- /proc/modules/${MODULE_NAME} --------"
grep ${MODULE_NAME} /proc/modules
echo ""
sleep 5
echo "Now your box may be vulnerable to CVE-2017-18017 if you have not apply the appropriate patch, i guess..."
#### end main part ####
exit 0
